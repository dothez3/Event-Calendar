{% extends "base.html" %}
{% block content %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

<div class="d-flex justify-content-between align-items-center mb-3">
  <h2>Projects</h2>
  <div class="d-flex gap-2 align-items-center">
    <!-- Toggle View Buttons -->
    <div class="btn-group" role="group">
      <button type="button" class="btn btn-outline-primary" id="tableViewBtn" onclick="showTableView()">
        <i class="bi bi-table"></i> Table View
      </button>
      <button type="button" class="btn btn-outline-primary" id="cardViewBtn" onclick="showCardView()">
        <i class="bi bi-card-list"></i> Card View
      </button>
    </div>
    <!-- Create Project Button (Employees Only) -->
    {% if current_user.role == 'employee' %}
    <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#createProjectModal">
      <i class="bi bi-plus-circle"></i> Create New Project
    </button>
    {% endif %}
  </div>
</div>

<!-- Search and Sort Bar -->
<form method="get" action="{{ url_for('projects') }}" class="row g-3 mb-4" autocomplete="off">
  <div class="col-md-7">
    <input 
      name="q" 
      class="form-control" 
      placeholder="Search by name, description, or client…" 
      value="{{ q or '' }}"
    >
  </div>
  <div class="col-md-3">
    <select name="sort" class="form-select">
      <option value="name" {% if sort_by == 'name' %}selected{% endif %}>Sort by Name</option>
      <option value="due_date" {% if sort_by == 'due_date' %}selected{% endif %}>Sort by Due Date</option>
      <option value="status" {% if sort_by == 'status' %}selected{% endif %}>Sort by Status</option>
      <option value="client" {% if sort_by == 'client' %}selected{% endif %}>Sort by Client</option>
    </select>
  </div>
  <div class="col-md-2">
    <button class="btn btn-primary w-100">Search</button>
  </div>
</form>

<!-- Table View Container -->
<div id="tableView">
  <table class="table table-striped">
    <thead>
      <tr>
        <th>Name</th>
        <th>Client</th>
        <th>Building</th>
        <th>Status</th>
        <th>Due</th>
        <!-- Show assigned clients column for employees -->
        {% if current_user.role == 'employee' %}
          <th>Assigned Client Users</th>
        {% endif %}
        <th class="text-end">Actions</th>
      </tr>
    </thead>
    <tbody>
    {% for p in projects %}
      <tr class="clickable-row" data-href="{{ url_for('project_detail', id=p.id) }}">
        <td><strong>{{ p.name }}</strong></td>
        <td>{{ p.client.name if p.client else "-" }}</td>
        <td>{{ p.building.name if p.building else "-" }}</td>
        <td>
          {% if p.status == 'Planned' %}
            <span class="badge bg-secondary">{{ p.status }}</span>
          {% elif p.status == 'In Progress' %}
            <span class="badge bg-primary">{{ p.status }}</span>
          {% elif p.status == 'Overdue' %}
            <span class="badge bg-danger">{{ p.status }}</span>
          {% elif p.status == 'Done' %}
            <span class="badge bg-success">{{ p.status }}</span>
          {% else %}
            <span class="badge bg-secondary">{{ p.status }}</span>
          {% endif %}
        </td>
        <td {% if p.is_overdue or p.status == 'Overdue' %}style="color: red; font-weight: bold;"{% endif %}>{{ p.due_date or "-" }}</td>

        <!-- Show and manage assigned client users (employees only) -->
        {% if current_user.role == 'employee' %}
          <td>
            {% if p.assignments %}
              <div class="mb-2">
                {% for assignment in p.assignments %}
                  <div class="d-inline-flex align-items-center bg-secondary text-white rounded px-2 py-1 me-1 mb-1">
                    <span class="me-2">{{ assignment.user.name }}</span>
                    <form method="post" action="{{ url_for('unassign_client_from_project', project_id=p.id, user_id=assignment.user.id) }}" class="d-inline m-0">
                      <button type="submit" class="btn btn-sm p-0 text-white border-0" style="background: none; font-size: 1.2rem; line-height: 1;" 
                              onclick="return confirm('Remove {{ assignment.user.name }} from this project?')"
                              title="Remove user">×</button>
                    </form>
                  </div>
                {% endfor %}
              </div>
            {% endif %}
            <!-- Assign new client form -->
            <form method="post" action="{{ url_for('assign_client_to_project', project_id=p.id) }}" class="d-flex gap-1">
              <select name="user_id" class="form-select form-select-sm" style="max-width: 150px;">
                <option value="">Assign client...</option>
                {% for user in users %}
                  <option value="{{ user.id }}">{{ user.name }}</option>
                {% endfor %}
              </select>
              <button type="submit" class="btn btn-sm btn-outline-primary">+</button>
            </form>
          </td>
        {% endif %}

        <td class="text-end">
          {% if current_user.role == 'employee' %}
            <form class="d-inline" method="post" action="{{ url_for('projects_delete', id=p.id) }}">
              <button class="btn btn-sm btn-outline-danger"
                  onclick="return confirm('Delete this project?')">
                Delete
              </button>
            </form>
          {% else %}
            <span class="text-muted">-</span>
          {% endif %}
        </td>
      </tr>
    {% else %}
      <tr><td colspan="{% if current_user.role == 'employee' %}7{% else %}6{% endif %}" class="text-center text-muted">
        {% if current_user.role == 'client' %}
          No projects assigned to you yet. Contact an employee to get access.
        {% else %}
          No projects yet.
        {% endif %}
      </td></tr>
    {% endfor %}
    </tbody>
  </table>
</div>

<!-- Card View Container -->
<div id="cardView" style="display: none;">
  <div class="row row-cols-1 row-cols-md-3 g-4">
    {% for p in projects %}
    <div class="col">
      <div class="card h-100 shadow-sm clickable-card" data-href="{{ url_for('project_detail', id=p.id) }}">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-start mb-2">
            <h5 class="card-title mb-0">{{ p.name }}</h5>
            {% if p.status == 'Planned' %}
              <span class="badge bg-secondary">{{ p.status }}</span>
            {% elif p.status == 'In Progress' %}
              <span class="badge bg-primary">{{ p.status }}</span>
            {% elif p.status == 'Overdue' %}
              <span class="badge bg-danger">{{ p.status }}</span>
            {% elif p.status == 'Done' %}
              <span class="badge bg-success">{{ p.status }}</span>
            {% else %}
              <span class="badge bg-secondary">{{ p.status }}</span>
            {% endif %}
          </div>
          <p class="mb-1"><strong>Client:</strong> {{ p.client.name if p.client else "-" }}</p>
          <p class="mb-1"><strong>Building:</strong> {{ p.building.name if p.building else "-" }}</p>
          <p class="mb-1" {% if p.is_overdue or p.status == 'Overdue' %}style="color: red; font-weight: bold;"{% endif %}>
            <strong>Due:</strong> {{ p.due_date or "-" }}
          </p>
          {% if p.description %}
          <p class="mb-0 mt-2 text-muted small">{{ p.description[:100] }}{% if p.description|length > 100 %}...{% endif %}</p>
          {% endif %}
        </div>

        <!-- Card Footer for Employees -->
        {% if current_user.role == 'employee' %}
        <div class="card-footer bg-light d-flex justify-content-end">
          <form class="d-inline" method="post" action="{{ url_for('projects_delete', id=p.id) }}">
            <button class="btn btn-sm btn-outline-danger"
                onclick="return confirm('Delete this project?')">
              <i class="bi bi-trash"></i> Delete
            </button>
          </form>
        </div>
        {% endif %}
      </div>
    </div>
    {% else %}
    <div class="col">
      <p class="text-muted">
        {% if current_user.role == 'client' %}
          No projects assigned to you yet. Contact an employee to get access.
        {% else %}
          No projects yet.
        {% endif %}
      </p>
    </div>
    {% endfor %}
  </div>
</div>

<!-- Pagination Controls -->
{% if pagination and pagination.pages > 1 %}
<nav aria-label="Project pagination" class="mt-4">
  <ul class="pagination justify-content-center">
    <!-- Previous Button -->
    <li class="page-item {% if not pagination.has_prev %}disabled{% endif %}">
      <a class="page-link" href="{{ url_for('projects', page=pagination.prev_num, q=q, sort=sort_by) if pagination.has_prev else '#' }}">
        <i class="bi bi-chevron-left"></i> Previous
      </a>
    </li>
    
    <!-- Page Numbers -->
    {% for page_num in pagination.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=2) %}
      {% if page_num %}
        <li class="page-item {% if page_num == pagination.page %}active{% endif %}">
          <a class="page-link" href="{{ url_for('projects', page=page_num, q=q, sort=sort_by) }}">{{ page_num }}</a>
        </li>
      {% else %}
        <li class="page-item disabled">
          <span class="page-link">...</span>
        </li>
      {% endif %}
    {% endfor %}
    
    <!-- Next Button -->
    <li class="page-item {% if not pagination.has_next %}disabled{% endif %}">
      <a class="page-link" href="{{ url_for('projects', page=pagination.next_num, q=q, sort=sort_by) if pagination.has_next else '#' }}">
        Next <i class="bi bi-chevron-right"></i>
      </a>
    </li>
  </ul>
</nav>
{% endif %}

<!-- Create Project Modal -->
{% if current_user.role == 'employee' %}
<div class="modal fade" id="createProjectModal" tabindex="-1" aria-labelledby="createProjectModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="createProjectModalLabel">Create New Project</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form method="post" action="{{ url_for('projects_create') }}">
        <div class="modal-body">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">Project Name</label>
              <input name="name" class="form-control" placeholder="Enter project name" required>
            </div>
            <div class="col-md-6">
              <label class="form-label">Status</label>
              <select name="status" class="form-select">
                <option>Planned</option>
                <option>In Progress</option>
                <option>Overdue</option>
                <option>Done</option>
              </select>
            </div>
            <div class="col-md-6">
              <label class="form-label">Client</label>
              <select name="client_id" class="form-select">
                <option value="">No client</option>
                {% for c in clients %}
                  <option value="{{ c.id }}">{{ c.name }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-6">
              <label class="form-label">Building</label>
              <select name="building_id" class="form-select">
                <option value="">No building</option>
                {% for b in buildings %}
                  <option value="{{ b.id }}">{{ b.name }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-12">
              <label class="form-label">Due Date</label>
              <input name="due_date" type="date" class="form-control">
            </div>
            <div class="col-md-12">
              <label class="form-label">Description</label>
              <textarea name="description" class="form-control" rows="4" placeholder="Enter project description"></textarea>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-success">Create Project</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endif %}

<style>
  .clickable-row {
    cursor: pointer;
    transition: all 0.2s ease;
  }
  .clickable-row:hover {
    background-color: #f1f3f5 !important;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    transform: translateY(-2px);
  }
  
  .clickable-card {
    cursor: pointer;
    transition: all 0.2s ease;
  }
  .clickable-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 16px rgba(0,0,0,0.15) !important;
  }
</style>

<script>
// Get view from URL parameter or default to table
const urlParams = new URLSearchParams(window.location.search);
const currentView = urlParams.get('view') || 'table';

// Show Table View
function showTableView() {
  document.getElementById('tableView').style.display = 'block';
  document.getElementById('cardView').style.display = 'none';
  document.getElementById('tableViewBtn').classList.add('active');
  document.getElementById('cardViewBtn').classList.remove('active');
  
  // Update all pagination links to remember table view
  updatePaginationLinks('table');
}

// Show Card View
function showCardView() {
  document.getElementById('tableView').style.display = 'none';
  document.getElementById('cardView').style.display = 'block';
  document.getElementById('tableViewBtn').classList.remove('active');
  document.getElementById('cardViewBtn').classList.add('active');
  
  // Update all pagination links to remember card view
  updatePaginationLinks('card');
}

// Update pagination links to include current view
function updatePaginationLinks(view) {
  document.querySelectorAll('.pagination a.page-link').forEach(link => {
    if (link.href && link.href !== '#') {
      const url = new URL(link.href);
      url.searchParams.set('view', view);
      link.href = url.toString();
    }
  });
}

// Make table rows clickable
document.querySelectorAll('.clickable-row').forEach(row => {
  row.addEventListener('click', function(e) {
    // Don't navigate if clicking on buttons, links, or forms
    if (e.target.tagName !== 'BUTTON' && 
        e.target.tagName !== 'A' && 
        e.target.tagName !== 'SELECT' &&
        !e.target.closest('button') && 
        !e.target.closest('a') && 
        !e.target.closest('form')) {
      window.location = this.dataset.href;
    }
  });
});

// Make cards clickable
document.querySelectorAll('.clickable-card').forEach(card => {
  card.addEventListener('click', function(e) {
    // Don't navigate if clicking on buttons or forms
    if (e.target.tagName !== 'BUTTON' && 
        !e.target.closest('button') && 
        !e.target.closest('form')) {
      window.location = this.dataset.href;
    }
  });
});

// Restore view based on URL parameter
if (currentView === 'card') {
  showCardView();
} else {
  showTableView();
}
</script>

{% endblock %}