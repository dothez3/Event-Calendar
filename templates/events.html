{% extends "base.html" %}
{% block content %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
<style>
  /* Color coding for event types */
  .event-proposal { border-left: 8px solid #00ff00; } /* Blue */
  .event-survey { border-left: 8px solid #00ff00; } /* Green */
  .event-asbuilt { border-left: 8px solid #00ff00; } /* Orange */
  .event-design { border-left: 8px solid #00ff00; } /* Purple */
  .event-client-meeting { border-left: 8px solid #ffff00; } /* Brown */
  .event-drawings-created { border-left: 8px solid #ffff00; } /* Red */
  .event-drawings-printed { border-left: 8px solid #ff0000; } /* Teal */
  .event-bill-sent { border-left: 8px solid #ff0000; } /* Yellow */
  .event-default { border-left: 8px solid #6c757d; } /* Gray */

  
  .event-badge {
    font-size: 0.75rem;
    padding: 0.25rem 0.5rem;
  }
  
  /* Calendar styling */
  #calendar {
    max-width: 100%;
    margin: 0 auto;
    background: white;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  }
  
  /* FullCalendar event colors */
  .fc-event-proposal { 
    background-color: #00ff00 !important; 
    border-color: #00ff00 !important; 
    color: white !important;
  }
  .fc-event-survey { 
    background-color: #00ff00 !important; 
    border-color: #00ff00 !important; 
    color: white !important;
  }
  .fc-event-asbuilt { 
    background-color: #00ff00 !important; 
    border-color: #00ff00 !important; 
    color: white !important;
  }
  .fc-event-design { 
    background-color: #00ff00 !important; 
    border-color: #00ff00 !important; 
    color: white !important;
  }
  .fc-event-client-meeting { 
    background-color: #ffff00 !important; 
    border-color: #ffff00 !important; 
    color: white !important;
  }
  .fc-event-drawings-created { 
    background-color: #ffff00 !important; 
    border-color: #ffff00 !important; 
    color: white !important;
  }
  .fc-event-drawings-printed { 
    background-color: #ff0000 !important; 
    border-color: #ff0000 !important; 
    color: white !important;
  }
  .fc-event-bill-sent { 
    background-color: #ff0000 !important; 
    border-color: #ff0000 !important; 
    color: white !important;
  }
  
  /* Modern calendar event styling */
  .fc-event {
    border-radius: 4px !important;
    padding: 2px 4px !important;
    font-weight: 500 !important;
    cursor: pointer !important;
  }
  
  .fc-event:hover {
    opacity: 0.85 !important;
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0,0,0,0.2) !important;
  }
  
  /* Modal styling */
  .modal-backdrop {
    background-color: rgba(0, 0, 0, 0.5);
  }
</style>

<div class="d-flex justify-content-between align-items-center mb-3">
  <h2>Events</h2>
  <div class="btn-group" role="group">
    <button type="button" class="btn btn-outline-primary" id="cardViewBtn" onclick="showCardView()">
      <i class="bi bi-card-list"></i> Card View
    </button>
    <button type="button" class="btn btn-outline-primary" id="calendarViewBtn" onclick="showCalendarView()">
      <i class="bi bi-calendar3"></i> Calendar View
    </button>
  </div>
</div>

<!-- Card View Container -->
<div id="cardView">
  <!--  changes: Create Event Form (Employee Only) -->
  {% if current_user.role == 'employee' %}
  <form method="post" action="{{ url_for('events_create') }}" class="row g-3 mb-4">
    <div class="col-md-3">
      <input name="title" class="form-control" placeholder="Title (e.g., Site Visit)" required>
    </div>
    <div class="col-md-2">
      <select name="event_type" class="form-select">
        <option value="Proposal">Proposal</option>
        <option value="Survey">Survey</option>
        <option value="Asbuilt">Asbuilt</option>
        <option value="Design">Design</option>
        <option value="Client Meeting">Client Meeting</option>
        <option value="Drawings Created">Drawings Created</option>
        <option value="Drawings Printed">Drawings Printed</option>
        <option value="Bill Sent">Bill Sent</option>
      </select>
    </div>
    <div class="col-md-2">
      <select name="project_id" class="form-select">
        <option value="">Select Project</option>
        {% for p in projects %}
          <option value="{{ p.id }}">{{ p.name }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-2">
      <input name="start" type="datetime-local" class="form-control" required>
    </div>
    <div class="col-md-2">
      <input name="end" type="datetime-local" class="form-control">
    </div>
    <div class="col-md-12">
      <textarea name="notes" class="form-control" rows="2" placeholder="Notes (e.g., client requested layout changes)"></textarea>
    </div>
    <div class="col-md-2">
      <button class="btn btn-success w-100">Create Event</button>
    </div>
  </form>
  {% endif %}

  <!-- Event Cards -->
  <div class="row row-cols-1 row-cols-md-3 g-4">
    {% for e in events %}
    {% set event_class = 'event-' + (e.event_type.lower().replace(' ', '-') if e.event_type else 'default') %}
    <div class="col">
      <div class="card h-100 shadow-sm {{ event_class }}">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-start mb-2">
            <h5 class="card-title mb-0">{{ e.title }}</h5>
            {% if e.event_type %}
              {% if e.event_type == 'Blueprint Delivery' %}
                <span class="badge bg-primary event-badge">{{ e.event_type }}</span>
              {% elif e.event_type == 'Permit Submission' %}
                <span class="badge bg-success event-badge">{{ e.event_type }}</span>
              {% elif e.event_type == 'Client Meeting' %}
                <span class="badge bg-warning event-badge">{{ e.event_type }}</span>
              {% elif e.event_type == 'Design Review' %}
                <span class="badge" class="event-badge">{{ e.event_type }}</span>
              {% elif e.event_type == 'Site Visit' %}
                <span class="badge" class="event-badge">{{ e.event_type }}</span>
              {% elif e.event_type == 'Site Inspection' %}
                <span class="badge bg-danger event-badge">{{ e.event_type }}</span>
              {% elif e.event_type == 'Contractor Meeting' %}
                <span class="badge bg-info event-badge">{{ e.event_type }}</span>
              {% elif e.event_type == 'Deadline Milestone' %}
                <span class="badge" class="event-badge">{{ e.event_type }}</span>
              {% else %}
                <span class="badge bg-secondary event-badge">{{ e.event_type }}</span>
              {% endif %}
            {% endif %}
          </div>
          <p class="mb-1"><strong>Project:</strong> {{ e.project.name if e.project else "-" }}</p>
          <p class="mb-1"><strong>Start:</strong> {{ e.start.strftime('%Y-%m-%d %H:%M') }}</p>
          <p class="mb-1"><strong>End:</strong> {{ e.end.strftime('%Y-%m-%d %H:%M') if e.end else "-" }}</p>
          {% if e.notes %}
          <p class="mb-0 mt-2"><strong>Notes:</strong> {{ e.notes }}</p>
          {% endif %}
        </div>

        <!--  changes: Edit Section (Collapsible) - Employee Only -->
        {% if current_user.role == 'employee' %}
        <div class="collapse" id="edit{{ e.id }}">
          <div class="card-body border-top bg-light">
            <form method="post" action="{{ url_for('events_edit', event_id=e.id) }}">
              <div class="mb-2">
                <input name="title" class="form-control" value="{{ e.title }}" required>
              </div>
              <div class="mb-2">
                <select name="event_type" class="form-select">
                  <option value="Blueprint Delivery" {% if e.event_type == "Blueprint Delivery" %}selected{% endif %}>Blueprint Delivery</option>
                  <option value="Permit Submission" {% if e.event_type == "Permit Submission" %}selected{% endif %}>Permit Submission</option>
                  <option value="Client Meeting" {% if e.event_type == "Client Meeting" %}selected{% endif %}>Client Meeting</option>
                  <option value="Design Review" {% if e.event_type == "Design Review" %}selected{% endif %}>Design Review</option>
                  <option value="Site Visit" {% if e.event_type == "Site Visit" %}selected{% endif %}>Site Visit</option>
                  <option value="Site Inspection" {% if e.event_type == "Site Inspection" %}selected{% endif %}>Site Inspection</option>
                  <option value="Contractor Meeting" {% if e.event_type == "Contractor Meeting" %}selected{% endif %}>Contractor Meeting</option>
                  <option value="Deadline Milestone" {% if e.event_type == "Deadline Milestone" %}selected{% endif %}>Deadline/Milestone</option>
                </select>
              </div>
              <div class="mb-2">
                <select name="project_id" class="form-select">
                  <option value="">No project</option>
                  {% for p in projects %}
                    <option value="{{ p.id }}" {% if e.project_id == p.id %}selected{% endif %}>{{ p.name }}</option>
                  {% endfor %}
                </select>
              </div>
              <div class="mb-2">
                <input name="start" type="datetime-local" value="{{ e.start.strftime('%Y-%m-%dT%H:%M') }}" class="form-control" required>
              </div>
              <div class="mb-2">
                <input name="end" type="datetime-local" value="{{ e.end.strftime('%Y-%m-%dT%H:%M') if e.end else '' }}" class="form-control">
              </div>
              <div class="mb-2">
                <textarea name="notes" class="form-control" rows="2">{{ e.notes }}</textarea>
              </div>
              <div class="d-flex justify-content-end gap-2">
                <button class="btn btn-success btn-sm">Save</button>
                <button class="btn btn-secondary btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#edit{{ e.id }}">Cancel</button>
              </div>
            </form>
          </div>
        </div>
        {% endif %}

        <!--  changes: Card Footer - Employee Only -->
        {% if current_user.role == 'employee' %}
        <div class="card-footer d-flex justify-content-between bg-light">
          <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#edit{{ e.id }}">
            <i class="bi bi-pencil"></i> Edit
          </button>
          <form action="{{ url_for('events_delete', event_id=e.id) }}" method="post" style="display:inline;">
            <button type="submit" class="btn btn-sm btn-outline-danger" onclick="return confirm('Delete this event?')">
              <i class="bi bi-trash"></i> Delete
            </button>
          </form>
        </div>
        {% endif %}
      </div>
    </div>
    {% else %}
    <p class="text-muted">No events yet.</p>
    {% endfor %}
  </div>
</div>

<!-- Calendar View Container -->
<div id="calendarView" style="display: none;">
  <div id="calendar"></div>
</div>

<!--  changes: Modal for Quick Event Creation (Employee Only) -->
{% if current_user.role == 'employee' %}
<div class="modal fade" id="quickEventModal" tabindex="-1" aria-labelledby="quickEventModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="quickEventModalLabel">Create Event</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form method="post" action="{{ url_for('events_create') }}">
        <div class="modal-body">
          <div class="mb-3">
            <label for="modalTitle" class="form-label">Title</label>
            <input type="text" class="form-control" id="modalTitle" name="title" required>
          </div>
          <div class="mb-3">
            <label for="modalEventType" class="form-label">Event Type</label>
            <select class="form-select" id="modalEventType" name="event_type">
              <option value="Blueprint Delivery">Blueprint Delivery</option>
              <option value="Permit Submission">Permit Submission</option>
              <option value="Client Meeting">Client Meeting</option>
              <option value="Design Review">Design Review</option>
              <option value="Site Visit">Site Visit</option>
              <option value="Site Inspection">Site Inspection</option>
              <option value="Contractor Meeting">Contractor Meeting</option>
              <option value="Deadline Milestone">Deadline/Milestone</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="modalProject" class="form-label">Project</label>
            <select class="form-select" id="modalProject" name="project_id">
              <option value="">Select Project</option>
              {% for p in projects %}
                <option value="{{ p.id }}">{{ p.name }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="mb-3">
            <label for="modalStart" class="form-label">Start Date/Time</label>
            <input type="datetime-local" class="form-control" id="modalStart" name="start" required>
          </div>
          <div class="mb-3">
            <label for="modalEnd" class="form-label">End Date/Time</label>
            <input type="datetime-local" class="form-control" id="modalEnd" name="end">
          </div>
          <div class="mb-3">
            <label for="modalNotes" class="form-label">Notes</label>
            <textarea class="form-control" id="modalNotes" name="notes" rows="3"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-success">Create Event</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endif %}

<!-- Modal for Event Details -->
<div class="modal fade" id="eventDetailsModal" tabindex="-1" aria-labelledby="eventDetailsModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="eventDetailsModalLabel">Event Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <h4 id="detailTitle" class="mb-2"></h4>
          <span id="detailBadge" class="badge"></span>
        </div>
        <div class="mb-3">
          <p class="mb-1"><strong><i class="bi bi-briefcase"></i> Project:</strong> <span id="detailProject"></span></p>
          <p class="mb-1"><strong><i class="bi bi-calendar-event"></i> Start:</strong> <span id="detailStart"></span></p>
          <p class="mb-1"><strong><i class="bi bi-calendar-check"></i> End:</strong> <span id="detailEnd"></span></p>
        </div>
        <div class="mb-0" id="detailNotesContainer" style="display: none;">
          <p class="mb-1"><strong><i class="bi bi-sticky"></i> Notes:</strong></p>
          <p id="detailNotes" class="text-muted"></p>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <!--  changes: Edit/Delete buttons only for employees -->
        {% if current_user.role == 'employee' %}
        <button type="button" class="btn btn-outline-danger" id="deleteEventBtn">
          <i class="bi bi-trash"></i> Delete
        </button>
        <button type="button" class="btn btn-primary" id="editEventBtn">
          <i class="bi bi-pencil"></i> Edit
        </button>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<script>
let calendar;

// Show Card View
function showCardView() {
  document.getElementById('cardView').style.display = 'block';
  document.getElementById('calendarView').style.display = 'none';
  document.getElementById('cardViewBtn').classList.add('active');
  document.getElementById('calendarViewBtn').classList.remove('active');
}

// Show Calendar View
function showCalendarView() {
  document.getElementById('cardView').style.display = 'none';
  document.getElementById('calendarView').style.display = 'block';
  document.getElementById('cardViewBtn').classList.remove('active');
  document.getElementById('calendarViewBtn').classList.add('active');
  
  // Initialize calendar if not already done
  if (!calendar) {
    initCalendar();
  }
}

// Initialize FullCalendar
function initCalendar() {
  const calendarEl = document.getElementById('calendar');
  
  // Convert events from Jinja to JavaScript
  const events = [
    {% for e in events %}
    {
      id: {{ e.id }},
      title: '{{ e.title }}',
      start: '{{ e.start.strftime('%Y-%m-%dT%H:%M:%S') }}',
      {% if e.end %}
      end: '{{ e.end.strftime('%Y-%m-%dT%H:%M:%S') }}',
      {% endif %}
      className: 'fc-event-{{ e.event_type.lower().replace(" ", "-") if e.event_type else "default" }}',
      extendedProps: {
        eventType: '{{ e.event_type }}',
        project: '{{ e.project.name if e.project else "" }}',
        notes: '{{ e.notes }}'
      }
    }{% if not loop.last %},{% endif %}
    {% endfor %}
  ];
  
  calendar = new FullCalendar.Calendar(calendarEl, {
    initialView: 'dayGridMonth',
    headerToolbar: {
      left: 'prev,next today',
      center: 'title',
      right: 'dayGridMonth,timeGridWeek,timeGridDay'
    },
    events: events,
    eventClick: function(info) {
      // Show event details in modal
      const modal = new bootstrap.Modal(document.getElementById('eventDetailsModal'));
      
      // Get event type badge color
      const eventType = info.event.extendedProps.eventType;
      let badgeClass = 'bg-secondary';
      if (eventType === 'Blueprint Delivery') badgeClass = 'bg-primary';
      else if (eventType === 'Permit Submission') badgeClass = 'bg-success';
      else if (eventType === 'Client Meeting') badgeClass = 'bg-warning';
      else if (eventType === 'Design Review') badgeClass = 'badge';
      else if (eventType === 'Site Visit') badgeClass = 'badge';
      else if (eventType === 'Site Inspection') badgeClass = 'bg-danger';
      else if (eventType === 'Contractor Meeting') badgeClass = 'bg-info';
      else if (eventType === 'Deadline Milestone') badgeClass = 'bg-warning';
      
      // Populate modal with event details
      document.getElementById('detailTitle').textContent = info.event.title;
      
      const badge = document.getElementById('detailBadge');
      badge.textContent = eventType;
      badge.className = 'badge ' + badgeClass;
      if (eventType === 'Design Review') badge.style.backgroundColor = '#6f42c1';
      if (eventType === 'Site Visit') badge.style.backgroundColor = '#8b4513';
      if (eventType === 'Deadline Milestone') badge.style.backgroundColor = '#e0a800';
      
      document.getElementById('detailProject').textContent = info.event.extendedProps.project || 'No project assigned';
      document.getElementById('detailStart').textContent = info.event.start.toLocaleString();
      document.getElementById('detailEnd').textContent = info.event.end ? info.event.end.toLocaleString() : 'Not specified';
      
      // Show/hide notes
      if (info.event.extendedProps.notes) {
        document.getElementById('detailNotesContainer').style.display = 'block';
        document.getElementById('detailNotes').textContent = info.event.extendedProps.notes;
      } else {
        document.getElementById('detailNotesContainer').style.display = 'none';
      }
      
      //  changes: Only set up edit/delete handlers if user is employee
      {% if current_user.role == 'employee' %}
      // Store event ID for edit/delete actions
      document.getElementById('editEventBtn').onclick = function() {
        // Redirect to card view and trigger edit
        showCardView();
        modal.hide();
        // Scroll to the event card and expand edit form
        setTimeout(() => {
          const editBtn = document.querySelector(`[data-bs-target="#edit${info.event.id}"]`);
          if (editBtn) {
            editBtn.scrollIntoView({ behavior: 'smooth', block: 'center' });
            editBtn.click();
          }
        }, 300);
      };
      
      document.getElementById('deleteEventBtn').onclick = function() {
        if (confirm('Are you sure you want to delete this event?')) {
          // Create form and submit delete request
          const form = document.createElement('form');
          form.method = 'POST';
          form.action = `/events/delete/${info.event.id}`;
          document.body.appendChild(form);
          form.submit();
        }
      };
      {% endif %}
      
      modal.show();
    },
    //  changes: Only allow date clicking for employees
    {% if current_user.role == 'employee' %}
    dateClick: function(info) {
      // Open modal when clicking on a date
      const modal = new bootstrap.Modal(document.getElementById('quickEventModal'));
      
      // Pre-fill the start date/time with the clicked date at 9 AM
      const clickedDate = new Date(info.dateStr);
      clickedDate.setHours(9, 0, 0, 0);
      const dateTimeString = clickedDate.toISOString().slice(0, 16);
      document.getElementById('modalStart').value = dateTimeString;
      
      // Clear other fields
      document.getElementById('modalTitle').value = '';
      document.getElementById('modalEventType').selectedIndex = 0;
      document.getElementById('modalProject').selectedIndex = 0;
      document.getElementById('modalEnd').value = '';
      document.getElementById('modalNotes').value = '';
      
      modal.show();
    },
    {% endif %}
    height: 'auto'
  });
  
  calendar.render();
}

// Set Card View as default on load
document.getElementById('cardViewBtn').classList.add('active');
</script>

{% endblock %}