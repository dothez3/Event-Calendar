{% extends "base.html" %}
{% block content %}
<h2>Events</h2>

<!-- Create Event Form -->
<form method="post" action="{{ url_for('events_create') }}" class="row g-3 mb-4">
  <div class="col-md-3">
    <input name="title" class="form-control" placeholder="Title (e.g., Site Visit)" required>
  </div>
  <div class="col-md-2">
    <select name="event_type" class="form-select">
      <option value="Site Visit">Site Visit</option>
      <option value="Client Meeting">Client Meeting</option>
      <option value="Permit Submission">Permit Submission</option>
      <option value="Design Revision">Design Revision</option>
      <option value="Blueprint Delivery">Blueprint Delivery</option>
    </select>
  </div>
  <div class="col-md-2">
    <select name="project_id" class="form-select">
      <option value="">Select Project</option>
      {% for p in projects %}
        <option value="{{ p.id }}">{{ p.name }}</option>
      {% endfor %}
    </select>
  </div>
  <div class="col-md-2">
    <input name="start" type="datetime-local" class="form-control" required>
  </div>
  <div class="col-md-2">
    <input name="end" type="datetime-local" class="form-control">
  </div>
  <div class="col-md-12">
    <textarea name="notes" class="form-control" rows="2" placeholder="Notes (e.g., client requested layout changes)"></textarea>
  </div>
  <div class="col-md-2">
    <button class="btn btn-success w-100">Create Event</button>
  </div>
</form>

<!-- Event Cards -->
<div class="row row-cols-1 row-cols-md-3 g-4">
  {% for e in events %}
  <div class="col">
    <div class="card h-100 shadow-sm">
      <div class="card-body">
        <h5 class="card-title">{{ e.title }}</h5>
        <p><strong>Type:</strong> {{ e.event_type or "-" }}</p>
        <p><strong>Project:</strong> {{ e.project.name if e.project else "-" }}</p>
        <p><strong>Start:</strong> {{ e.start.strftime('%Y-%m-%d %H:%M') }}</p>
        <p><strong>End:</strong> {{ e.end.strftime('%Y-%m-%d %H:%M') if e.end else "-" }}</p>
        {% if e.notes %}
        <p><strong>Notes:</strong> {{ e.notes }}</p>
        {% endif %}
      </div>

      <!-- Edit Section (Collapsible) -->
      <div class="collapse" id="edit{{ e.id }}">
        <div class="card-body border-top bg-light">
          <form method="post" action="{{ url_for('events_edit', event_id=e.id) }}">
            <div class="mb-2">
              <input name="title" class="form-control" value="{{ e.title }}" required>
            </div>
            <div class="mb-2">
              <select name="event_type" class="form-select">
                <option value="Site Visit" {% if e.event_type == "Site Visit" %}selected{% endif %}>Site Visit</option>
                <option value="Client Meeting" {% if e.event_type == "Client Meeting" %}selected{% endif %}>Client Meeting</option>
                <option value="Permit Submission" {% if e.event_type == "Permit Submission" %}selected{% endif %}>Permit Submission</option>
                <option value="Design Revision" {% if e.event_type == "Design Revision" %}selected{% endif %}>Design Revision</option>
                <option value="Blueprint Delivery" {% if e.event_type == "Blueprint Delivery" %}selected{% endif %}>Blueprint Delivery</option>
              </select>
            </div>
            <div class="mb-2">
              <select name="project_id" class="form-select">
                <option value="">No project</option>
                {% for p in projects %}
                  <option value="{{ p.id }}" {% if e.project_id == p.id %}selected{% endif %}>{{ p.name }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="mb-2">
              <input name="start" type="datetime-local" value="{{ e.start.strftime('%Y-%m-%dT%H:%M') }}" class="form-control" required>
            </div>
            <div class="mb-2">
              <input name="end" type="datetime-local" value="{{ e.end.strftime('%Y-%m-%dT%H:%M') if e.end else '' }}" class="form-control">
            </div>
            <div class="mb-2">
              <textarea name="notes" class="form-control" rows="2">{{ e.notes }}</textarea>
            </div>
            <div class="d-flex justify-content-end gap-2">
              <button class="btn btn-success btn-sm">Save</button>
              <button class="btn btn-secondary btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#edit{{ e.id }}">Cancel</button>
            </div>
          </form>
        </div>
      </div>

      <!-- Card Footer -->
      <div class="card-footer d-flex justify-content-between">
        <button class="btn btn-sm btn-primary" type="button" data-bs-toggle="collapse" data-bs-target="#edit{{ e.id }}">Edit</button>
        <form action="{{ url_for('events_delete', event_id=e.id) }}" method="post" style="display:inline;">
          <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('Delete this event?')">Delete</button>
        </form>
      </div>
    </div>
  </div>
  {% else %}
  <p class="text-muted">No events yet.</p>
  {% endfor %}
</div>
{% endblock %}