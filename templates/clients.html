{% extends "base.html" %}
{% block content %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

<div class="d-flex justify-content-between align-items-center mb-3">
  <h2>Clients</h2>
  <div>
    <span class="text-muted">{{ clients|length }} client(s)</span>
  </div>
</div>

<!-- Search and Sort Bar -->
<form method="get" action="{{ url_for('clients') }}" class="row g-3 mb-4">
  <div class="col-md-8">
    <div class="input-group">
      <span class="input-group-text"><i class="bi bi-search"></i></span>
      <input 
        type="text" 
        name="q" 
        class="form-control" 
        placeholder="Search by name, email, phone, or address..." 
        value="{{ search_query or '' }}"
      >
    </div>
  </div>
  <div class="col-md-2">
    <select name="sort" class="form-select">
      <option value="name" {% if sort_by == 'name' %}selected{% endif %}>Sort by Name</option>
      <option value="city" {% if sort_by == 'city' %}selected{% endif %}>Sort by City</option>
      <option value="state" {% if sort_by == 'state' %}selected{% endif %}>Sort by State</option>
    </select>
  </div>
  <div class="col-md-2">
    <button type="submit" class="btn btn-primary w-100">Search</button>
  </div>
</form>

<!-- Create Client Form with Address Fields -->
<form method="post" action="{{ url_for('clients_create') }}" class="row g-3 mb-4">
  <div class="col-md-3">
    <input name="name" class="form-control" placeholder="Client name" required>
  </div>
  <div class="col-md-3">
    <input name="contact" class="form-control" placeholder="Contact email">
  </div>
  <div class="col-md-2">
    <input name="phone" class="form-control" placeholder="Contact phone">
  </div>
  <!-- Address Fields -->
  <div class="col-md-4">
    <input name="street" class="form-control" placeholder="Street address">
  </div>
  <div class="col-md-3">
    <input name="city" class="form-control" placeholder="City">
  </div>
  <div class="col-md-2">
    <input name="state" class="form-control" placeholder="State" maxlength="2">
  </div>
  <div class="col-md-2">
    <input name="zip" class="form-control" placeholder="ZIP code">
  </div>
  <div class="col-md-5"></div> <!-- Spacer -->
  <div class="col-md-12 text-center">
    <button class="btn btn-success px-5">Add Client</button>
  </div>
</form>

<!-- Clients Table with Address, Project Count, Icons, and Edit Button -->
<table class="table table-hover align-middle">
  <thead>
    <tr>
      <th>Name</th>
      <th>Contact</th>
      <th>Phone</th>
      <th>Address</th>
      <th>Projects</th>
      <th class="text-end">Actions</th>
    </tr>
  </thead>
  <tbody>
  {% for c in clients %}
    <tr class="clickable-row" data-href="{{ url_for('client_detail', id=c.id) }}">
      <td><strong>{{ c.name }}</strong></td>
      <td>
        {% if c.contact %}
          <a href="mailto:{{ c.contact }}" class="text-decoration-none">
            <i class="bi bi-envelope"></i> {{ c.contact }}
          </a>
        {% else %}
          -
        {% endif %}
      </td>
      <td>
        {% if c.phone %}
          <i class="bi bi-telephone"></i> {{ c.phone }}
        {% else %}
          -
        {% endif %}
      </td>
      <td>
        {% if c.street or c.city or c.state or c.zip %}
          <i class="bi bi-geo-alt"></i>
          {{ c.street or "" }}
          {% if c.city %}{{ ", " if c.street else "" }}{{ c.city }}{% endif %}
          {% if c.state %}{{ ", " if c.city else "" }}{{ c.state }}{% endif %}
          {% if c.zip %} {{ c.zip }}{% endif %}
        {% else %}
          -
        {% endif %}
      </td>
      <td>
        {% if c.project_count > 0 %}
          <a href="{{ url_for('projects', q=c.name) }}" class="badge bg-primary text-decoration-none">
            {{ c.project_count }} Project{{ 's' if c.project_count != 1 else '' }}
          </a>
        {% else %}
          <span class="text-muted">No projects</span>
        {% endif %}
      </td>
      <td class="text-end">
        <!-- Edit Button - toggles collapsible edit form -->
        <button class="btn btn-sm btn-outline-primary" type="button" data-bs-toggle="collapse" data-bs-target="#edit{{ c.id }}">
          Edit
        </button>
        <!-- Delete Button -->
        <form class="d-inline" method="post" action="{{ url_for('clients_delete', id=c.id) }}">
          <button class="btn btn-sm btn-outline-danger"
                  onclick="return confirm('Delete this client?')">
            Delete
          </button>
        </form>
      </td>
    </tr>
    
    <!-- Collapsible Edit Form Row -->
    <tr class="collapse" id="edit{{ c.id }}">
      <td colspan="6" class="bg-light">
        <form method="post" action="{{ url_for('clients_update', id=c.id) }}" class="row g-3 p-3">
          <div class="col-md-3">
            <label class="form-label">Name</label>
            <input name="name" class="form-control" value="{{ c.name }}" required>
          </div>
          <div class="col-md-3">
            <label class="form-label">Contact Email</label>
            <input name="contact" class="form-control" value="{{ c.contact or '' }}">
          </div>
          <div class="col-md-2">
            <label class="form-label">Phone</label>
            <input name="phone" class="form-control" value="{{ c.phone or '' }}">
          </div>
          <div class="col-md-4">
            <label class="form-label">Street Address</label>
            <input name="street" class="form-control" value="{{ c.street or '' }}">
          </div>
          <div class="col-md-3">
            <label class="form-label">City</label>
            <input name="city" class="form-control" value="{{ c.city or '' }}">
          </div>
          <div class="col-md-2">
            <label class="form-label">State</label>
            <input name="state" class="form-control" value="{{ c.state or '' }}" maxlength="2">
          </div>
          <div class="col-md-2">
            <label class="form-label">ZIP Code</label>
            <input name="zip" class="form-control" value="{{ c.zip or '' }}">
          </div>
          <div class="col-md-5"></div> <!-- Spacer -->
          <div class="col-md-12 text-end">
            <button class="btn btn-success">Save Changes</button>
            <button class="btn btn-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#edit{{ c.id }}">Cancel</button>
          </div>
        </form>
      </td>
    </tr>
  {% else %}
    <tr>
      <td colspan="6" class="text-center text-muted">
        {% if search_query %}
          No clients found matching "{{ search_query }}". <a href="{{ url_for('clients') }}">Clear search</a>
        {% else %}
          No clients yet.
        {% endif %}
      </td>
    </tr>
  {% endfor %}
  </tbody>
</table>

<style>
  .clickable-row {
    cursor: pointer;
    transition: all 0.2s ease;
  }
  .clickable-row:hover {
    background-color: #f1f3f5 !important;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    transform: translateY(-2px);
  }
</style>

<script>
  // Make table rows clickable
  document.querySelectorAll('.clickable-row').forEach(row => {
    row.addEventListener('click', function(e) {
      // Don't navigate if clicking on buttons or links
      if (e.target.tagName !== 'BUTTON' && e.target.tagName !== 'A' && !e.target.closest('button') && !e.target.closest('a')) {
        window.location = this.dataset.href;
      }
    });
  });
</script>

{% endblock %}